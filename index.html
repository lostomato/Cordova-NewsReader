<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">


<!--link rel="stylesheet" href="css/jquery.mobile-1.3.2.min.css">
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" /-->
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css">
<link href="css/glDatePicker.default.css" rel="stylesheet">
<link rel="stylesheet" href="css/scrollbar.css">
<!--script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script-->
<script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>

<script>
    $(document).bind('mobileinit',function(){
        //$.mobile.changePage.defaults.changeHash = false;
        //$.mobile.hashListeningEnabled = false;
        $.mobile.pushStateEnabled = false;
    });
</script>
<!--script src="js/jquery.mobile-1.3.2.min.js"></script>
<script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script-->
<script src="js/jquery.mobile-1.4.5.min.js"></script>

<script src="js/glDatePicker.js"></script>
<script type="text/javascript" src="js/connect.js"></script>

<script src="js/iscroll.js"></script>

<script type="text/javascript">

var myScroll,
	pullDownEl, pullDownOffset,
	pullUpEl, pullUpOffset,dateInput,
    requestCounter = 1,
    requestDateCounter = 1,
	generatedCount = 0;
    refreshForNewdz = false;
    dateSwitch = false;
    initLink = '/dz/getdz.php?jsoncallback=?';
    initMaxIDLink = '/dz/getmaxid.php?jsoncallback=?';
    pDALink = '/dz/getdz.php?jsoncallback=?';
    pUALink = '/dz/getdz.php?requestCounter='+requestCounter+'&jsoncallback=?';

/**
 * 下拉刷新 （自定义实现此方法）
 * myScroll.refresh();		// 数据加载完成后，调用界面更新方法
 */
function pullDownAction () {
    if($("#newdz_notice").is(":visible")) 
    {   
                    $.getJSON(pDALink,function (data) {
                    //$.mobile.showPageLoadingMsg();
                    // create a variable to hold the parsed output from the server
                    var output = [];
                    // if the PHP script returned a success
                    if (data.status == 'success') {
                        //$.mobile.hidePageLoadingMsg();
                        // iterate through the response rows
                        for (var key in data.items) {
                            var myString =data.items[key];
                            output.push('<li style="white-space:pre-wrap;" onclick="onClickLi();"> ' + myString + '</li>');
                        }
                        storage.clear();
                        storage.setItem("maxid",data.maxid);
                        storage.setItem("newstContent",output.join(''));
                    } else {
                        output.push('<li>No Data Found</li>');
                    }
                    $("#thelist").empty();
                    $(output.join('') ).appendTo("#thelist");
                    $("#thelist").trigger("create");
                    $("#newdz_notice").hide();
                    myScroll.refresh();
                });        
    }else{
        myScroll.refresh();
    }
}

/**
 * 滚动翻页 （自定义实现此方法）
 * myScroll.refresh();		// 数据加载完成后，调用界面更新方法
 */
function pullUpAction () {
    if(dateSwitch==true){ 
        pUALink = '/dz/getdz.php?requestDate='+dateInput+'&requestDateCounter='+requestDateCounter+'&jsoncallback=?';
    }else{
        pUALink = '/dz/getdz.php?requestCounter='+requestCounter+'&jsoncallback=?';
    }        

    if(requestCounter>10 || requestDateCounter >10){
        alert("已经是所有段子了。");
        return;
    }else{
        if(dateSwitch==true){
            ++requestDateCounter;
            }else{
            ++requestCounter;                
            }
		$.getJSON(pUALink,function (data) {
            console.log(pUALink);
                    //$.mobile.showPageLoadingMsg();
                    // create a variable to hold the parsed output from the server
                    var output = [];
                    // if the PHP script returned a success
                    if (data.status == 'success') {
                        //$.mobile.hidePageLoadingMsg();
                        // iterate through the response rows
                        for (var key in data.items) {
                            var myString =data.items[key];
                            //myString = myString.replace("\\n", "");
                            //myString = myString.Replace("\r\n", "");
                            //myString = myString.Replace("\\r\\n", "");
                            output.push('<li style="white-space:pre-wrap;" onclick="onClickLi();">' + myString + '</li>');
                        }
                    // if the PHP script returned an error
                    } else {
                        output.push('<li>No Data Found</li>');
                    }
                    $(output.join('') ).appendTo("#thelist");
                    $("#thelist").trigger("create");
                    myScroll.refresh();
                });            
    }
}

/**
 * 初始化iScroll控件
 */
function loaded() {
	pullDownEl = document.getElementById('pullDown');
	pullDownOffset = pullDownEl.offsetHeight;
	pullUpEl = document.getElementById('pullUp');	
	pullUpOffset = pullUpEl.offsetHeight;
	
	myScroll = new iScroll('wrapper', {
		scrollbarClass: 'myScrollbar', /* 重要样式 */
		useTransition: false, /* 此属性不知用意，本人从true改为false */
		topOffset: pullDownOffset,
		onRefresh: function () {
			if (pullDownEl.className.match('loading')) {
				pullDownEl.className = '';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
			} else if (pullUpEl.className.match('loading')) {
				pullUpEl.className = '';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
			}
		},
		onScrollMove: function () {
			if (this.y > 5 && !pullDownEl.className.match('flip')) {
				pullDownEl.className = 'flip';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = '松手开始更新...';
				this.minScrollY = 0;
			} else if (this.y < 5 && pullDownEl.className.match('flip')) {
				pullDownEl.className = '';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
				this.minScrollY = -pullDownOffset;
			} else if (this.y < (this.maxScrollY - 5) && !pullUpEl.className.match('flip')) {
				pullUpEl.className = 'flip';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = '松手开始更新...';
				this.maxScrollY = this.maxScrollY;
			} else if (this.y > (this.maxScrollY + 5) && pullUpEl.className.match('flip')) {
				pullUpEl.className = '';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
				this.maxScrollY = pullUpOffset;
			}
		},
		onScrollEnd: function () {
			if (pullDownEl.className.match('flip')) {
				pullDownEl.className = 'loading';
				pullDownEl.querySelector('.pullDownLabel').innerHTML = '加载中...';				
				pullDownAction();	// Execute custom function (ajax call?)
			} else if (pullUpEl.className.match('flip')) {
				pullUpEl.className = 'loading';
				pullUpEl.querySelector('.pullUpLabel').innerHTML = '加载中...';				
				pullUpAction();	// Execute custom function (ajax call?)
			}
		}
	});
	
	//setTimeout(function () { document.getElementById('wrapper').style.left = '0'; }, 800);
}

//初始化绑定iScroll控件 
//document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
</script>


<link rel="stylesheet" href="css/duanzi.css">
<script>
function mynew(){
    dateSwitch = false;
    $("#mycalenda").hide();
    if(storage.newstContent){
        $("#thelist li").remove();
		$(storage.getItem("newstContent")).appendTo("#thelist");
		$("#thelist").trigger("create");
	}
    $("#wrapper").css("top","75px");
    $("#wrapper").show();
    setTimeout(function () {//refresh the myScroll, otherwise there will be length confilct with mycalender() and myarchive(), cauz here is only one wrapper. 
            myScroll.refresh();
        }, 0);
}
function mycalender(){
    $("#wrapper").hide();    
    $("#mycalenda").show();
    $('div').find('[gldp-el=mydate]').css("display","block");
    setTimeout(function () {
            myScroll.refresh();
        }, 0);
}
function myarchive(){
    $("#mycalenda").hide();
    $("#wrapper").css("top","75px");
    $("#wrapper").hide();
}

function dateInputChange(date){//this function will be called in glDatePicker.js line 169.
    $("#wrapper").css("top","125px");
    $("#wrapper").show();
    dateInput = date;
    $("#thelist li").remove();
    console.log("/dz/getdz.php?requestDate="+dateInput+"&jsoncallback=?");
	$.getJSON("/dz/getdz.php?requestDate="+dateInput+"&jsoncallback=?",function (data) {
    // create a variable to hold the parsed output from the server
    var output = [];
    $.mobile.loading('show', {
        theme: "a",
        textonly: true,
        textVisible: true
    });
    //$.mobile.showPageLoadingMsg();
    // if the PHP script returned a success
    if (data.status == 'success') {
        // iterate through the response rows
        for (var key in data.items) {
            var myString =data.items[key];
            //myString = myString.replace("\\n", "");
            //myString = myString.replace("\r\n", "");
            //myString = myString.replace("\\r\\n", "");
            output.push('<li style="white-space:pre-wrap;" onclick="onClickLi();">' + myString + '</li>');
        }
        storage.removeItem("dateContent");
        storage.setItem("dateContent",output.join(''));
    // if the PHP script returned an error
    } else {
        $("#notice").show();
        output.push('<li>出错</li>');
    }
    $(output.join('') ).appendTo("#thelist");
    $.mobile.loading('hide');
    $("#thelist").trigger("create");
    dateSwitch = true;
    myScroll.refresh();
    });        
}
function onClickLi(e)
{/*
    e = e || window.event;
    e.target = e.target || e.srcElement;
    //alert(e.target.nodeName);
    alert($(e.target).text());*/
}

</script>
</head>
<body>
    <div data-role="header">
  <!--a id="content" href="#" data-role="button">首页</a-->
      <button id="seeb">登录</button>
      <h1>段子</h1>
      <a data-icon="bars" data-iconpos="left" href="#nav_menu" data-rel="popup" data-transition="slideup" class="ui-btn-right">设置</a>
      <div data-role="navbar">
          <ul>
              <li><a onclick="mynew()" class="ui-btn-active ui-state-persist">最新</a></li>
              <li><a onclick="mycalender()">按日历</a></li>
              <li><a onclick="myarchive()" >收藏</a></li>
          </ul>
          <ul>
              <li style="width:100%">
          <div>                         
              <script>
              $("#mydate").glDatePicker();
              </script>
              <div id="mycalenda" style="display:none">
                   <input type="text" id="mydate" gldp-id="mydate" readonly/>
                   <div gldp-el="mydate"
                        style="display:block; width:350px; height:300px; position:static; margin: 0 auto; top: 0;">
                   </div>
              </div>
          </div>
              <li>
          </ul>
      </div>
    </div>
    <div data-role="content">
         <div id="wrapper">
          <div id="scroller">
                  <div id="pullDown">
                      <span class="pullDownIcon"></span><span class="pullDownLabel">下拉刷新...</span>
                  </div>
                  <div id="test">                      
                      <div><p id="newdz_notice" style="display:none;">有新段子，下拉刷新</p></div>
                      <ul id="thelist" data-role="listview">
                      </ul>
                  </div>
                  <div id="pullUp">
                      <span class="pullUpIcon"></span><span class="pullUpLabel">上拉加载更多...</span>
                  </div>
          </div>
         </div>
    </div>
    <div class="ui-popup-container slideup in ui-popup-active" id="nav_menu-popup" tabindex="0">
        <div data-role="popup" id="nav_menu" data-theme="a" class="ui-popup ui-body-a ui-overlay-shadow ui-corner-all">
                <ul data-role="listview" class="ui-listview">
                    <li class="ui-first-child"><a href="" data-rel="dialog" data-transition="flip" class="ui-btn ui-btn-icon-right ui-icon-carat-r">系统注册</a></li>
                    <li class="ui-last-child"><a data-ajax="false" href="" class="ui-btn ui-btn-icon-right ui-icon-carat-r">关于本站</a></li>
                </ul>
        </div>
    </div>
</div>

</body>
</html>
